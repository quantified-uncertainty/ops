apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ .Values.name | required "name is required" }}
spec:
  endpoints:
  - interval: 60s
    path: "/_prometheus/metrics"
    basicAuth:
      username:
        # constant "elastic"
        name: {{ .Values.name }}-servicemonitor-user
        key: name
      password:
        name: {{ .Values.name }}-es-elastic-user
        key: elastic
selector:
  matchLabels:
    common.k8s.elastic.co/type: elasticsearch
    elasticsearch.k8s.elastic.co/cluster-name: {{ .Values.name }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.name }}-servicemonitor-user
type: Opaque
data:
  name: {{ "elastic" | b64enc }}
